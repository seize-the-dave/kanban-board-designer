<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Kanban Board Designer</title>
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
      html, body {
        margin: 0em;
      }
      /* div {
        border: 0.01em solid black;
      } */
      thead th {
        border-bottom: 3px solid black;
        border-right: 3px solid black;
        font-family: 'Permanent Marker', cursive;
        text-align: center;
        padding-bottom: 0.5em;
      }
      thead th a {
        color: black;
      }
      tbody td {
        border-right: 3px solid black;
      }
      tr th:last-child, tr td:last-child {
        border-right: 0px;
      }
      div.card {
        width: 60%;
        padding-top: 60%;
        margin: 1em auto;
      }
      div.card-blue {
        background-color: rgb(0, 155, 210);
      }
      div.card-yellow {
        background-color: #fff100;
      }
      div.card-green {
        background-color: rgb(220, 239, 78);
      }
      div.card-orange {
        background-color: rgb(254, 171, 39);
      }
      div.card-green {
        background-color: rgb(220, 239, 78);
      }
      div.card-pink {
        background-color: rgb(255, 90, 180);
        width: 60%;
        padding-top: 60%;
        margin: 1em auto;
      }
      .column-1 {
        width: 160px;
        padding: 0.5em;
      }
      .column-2 {
        width: 320px;
        padding: 0.5em;
      }
      .column-3 {
        width: 480px;
        padding: 0.5em;
      }
      .column-4 {
        width: 640px;
        padding: 0.5em;
      }
      div.buttons {
        font-size: 0.75em;
        padding-top: 0.5em;
      }
    </style>
    <link href="https://fonts.googleapis.com/css?family=Permanent+Marker" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script type="text/javascript">
        var lambdaUrl = "https://euq9lhwui2.execute-api.us-east-1.amazonaws.com/dev/board";

        var board = {
          "board": {
            "columns": [
              {name: "To Do", maxWip: 1},
              {name: "Ready", maxWip: 3},
              {name: "Development", maxWip: 5, "columns": [
                {name: "In Progress", maxWip: 3},
                {name: "Done", maxWip: 3},
              ]},
              {name: "Validation", maxWip: 4},
              {name: "Done", maxWip: 3}
            ]
          }
        };
        var boardId;

        var delColumn = function(indices) {
          var container = containerForIndices(indices.slice(0, -1));
          container.columns.splice(indices.pop(), 1);

          // First row and remaining columns
          if (indices.length !== 0 && container.columns.length === 0) {
            delete container.columns;
          }

          save(window.board);
        }

        var newColumn = function() {
          return {name: "New Column", maxWip: 1};
        }

        var addColumn = function(indices) {
          var container = containerForIndices(indices.slice(0, -1));
          container.columns.splice(indices.pop(), 0, newColumn());

          save(window.board);
        }

        var containerForIndices = function(indices) {
          var container = window.board.board;
          for (var i = 0; i < indices.length; i++) {
            container = container.columns[indices[i]];
          }
          return container;
        }

        var renameColumn = function(indices) {
          var container = containerForIndices(indices);
          container.name = window.prompt('Rename Column', container.name);

          save(window.board);
        }

        var splitColumn = function(indices) {
          var container = containerForIndices(indices);
          container.columns = [
            newColumn(),
            newColumn()
          ];

          save(window.board);
        }

        var changeMaxWip = function(indices) {
          var container = containerForIndices(indices);
          container.maxWip = window.prompt('Change Maxiumum WIP', container.maxWip);

          save(window.board);
        }

        var swapColumn = function(fromIndices, toIndices) {
          var fromColumns = window.board.board.columns;
          for (var i = 0; i < fromIndices.length - 1; i++) {
            fromColumns = fromColumns[fromIndices[i]].columns;
          }
          var fromIndex = fromIndices.pop();

          var toColumns = window.board.board.columns;
          for (var i = 0; i < toIndices.length - 1; i++) {
            toColumns = toColumns[toIndices[i]].columns;
          }
          var toIndex = toIndices.pop();

          var fromCol = fromColumns[fromIndex];
          var toCol = toColumns[toIndex];

          fromColumns[fromIndex] = toCol;
          toColumns[toIndex] = fromCol;

          save(window.board);
        }

        var renderHeader = function(tableHeader, columns) {
          var tableHeaderRow = $('<tr>').appendTo(tableHeader);
          var subColumns = [];
          for (var i = 0; i < columns.length; i++) {
              var column = columns[i];
              var span = 1;
              if (column.columns) {
                  span = column.columns.length;
                  subColumns = subColumns.concat(column.columns);
              } else {
                  subColumns.push(undefined)
              }

              var tableHeaderCell = writeTableHeader(tableHeaderRow, Math.max(1, span));
              writeColumnName(tableHeaderCell, column, [i], columns.length);
          }

          subcolumnsExist = subColumns.filter(col => col !== undefined).length;

          if (subcolumnsExist) {
            var tableHeaderRow = $('<tr>').appendTo(tableHeader);

            for (var i = 0; i < columns.length; i++) {
              if (columns[i].columns && columns[i].columns.length) {
                var subColumns = columns[i].columns;
                for (var j = 0; j < subColumns.length; j++) {
                  var subcolumn = subColumns[j];
                  var tableHeaderCell = writeTableHeader(tableHeaderRow, 1);
                  writeColumnName(tableHeaderCell, subcolumn, [i, j], subColumns.length);
                }
              } else {
                writeTableHeader(tableHeaderRow, 1);
              }
            }
          }
        }

        var render = function(board) {
          var columns = board['board']['columns'];
          var size = Math.floor(12 / columns.length);

          $('#board').empty();
          var table = $('<table>').appendTo('#board');
          var tableHeader = $('<thead>').appendTo(table);

          renderHeader(tableHeader, columns);

          var tableBody = $('<tbody>').appendTo(table);
          var tableBodyRow = $('<tr>').appendTo(tableBody);

          for (var i = 0; i < columns.length; i++) {
              var column = columns[i];
              if (column.columns && column.columns.length) {
                for (var j = 0; j < column.columns.length; j++) {
                  cardColumn(tableBodyRow);
                }
              } else {
                cardColumn(tableBodyRow);
              }
          }
        }

        var writeTableHeader = function(tableHeaderRow, span) {
          return $('<th colspan="' + span + '">').appendTo(tableHeaderRow);
        }

        var writeHeader = function(row, span) {
          return $('<div class="board-header column-' + span + '">').appendTo(row);
        }

        var findPosition = function(indices) {
          return indices.pop();
        }

        var writeColumnName = function(headerCell, column, indices, cols) {
          var thisOffset = findPosition(indices.slice(0));

          var rightIndices = indices.slice(0);
          rightIndices.pop();
          rightIndices.push(thisOffset + 1);

          var leftIndices = indices.slice(0);
          leftIndices.pop();
          leftIndices.push(thisOffset - 1);

          var indicesString = JSON.stringify(indices);
          headerCell.append('<a href="#" onclick="renameColumn(' + indicesString + ');">' + column.name + '</a> ');
          headerCell.append('(<a href="#" onclick="changeMaxWip(' + indicesString + ');">' + column.maxWip + '</a>)');
          headerCell.append('<br/>');

          var buttons = $('<div class="buttons">').appendTo(headerCell);
          if (thisOffset !== 0) {
              buttons.append('<button alt="Move Left" onclick="swapColumn(' + indicesString + ',' + JSON.stringify(leftIndices) + ');">&lt;</button>');
          }
          buttons.append('<button alt="Add Column to Left" onclick="addColumn(' + indicesString + ');">+</button>');
          buttons.append('<button alt="Delete Column" onclick="delColumn(' + indicesString + ');">-</button>');
          if (containerForIndices(indices).columns === undefined) {
            buttons.append('<button alt="Split into Two" onclick="splitColumn(' + indicesString + ');">||</button>');
          }
          buttons.append('<button alt="Add Column to Right"  onclick="addColumn(' + JSON.stringify(rightIndices) + ');">+</button>');
          if (thisOffset < (cols - 1)) {
              buttons.append('<button alt="Move Left" onclick="swapColumn(' + indicesString + ',' + JSON.stringify(rightIndices) + ');">&gt;</button>');
          }
        }

        var cardColumn = function(tableBodyRow) {
          var tableBodyCell = $('<td>').appendTo(tableBodyRow);
          var cardBoards = $('<div class="board-body column-1">').appendTo(tableBodyCell);
          var colours = ['yellow', 'yellow', 'yellow', 'blue', 'pink', 'orange', 'green'];

          for (var i = 0; i < 3; i++) {
            var randomColour = colours[Math.floor(colours.length * Math.random())];
            cardBoards.append('<div class="card card-' + randomColour + '">');
          }
        }

        var save = function(board) {
          $.ajax({
            type: "PUT",
            url: lambdaUrl + "?board=" + board.id,
            data: JSON.stringify(board),
            dataType: 'text',
          }).done(function() {
            render(board);
          });
        }

        var load = function(boardId) {
          $.ajax({
              type: "GET",
              url: lambdaUrl + "?board=" + boardId,
              dataType: 'json',
          }).done(function(data) {
            window.board = data;
            render(window.board);
          })
        }

        $('#board').ready(function(){
          window.boardId = new URL(window.location).searchParams.get("board");

          if (window.boardId == null) {
            $.ajax({
              type: "POST",
              url: lambdaUrl,
              data: JSON.stringify(window.board),
              dataType: 'text',
            }).done(function(data, textStatus, jqXHR) {
              window.boardId = new URL(jqXHR.getResponseHeader("location"), new URL(window.location)).searchParams.get("board");
              history.pushState({}, "Board", '?board=' + window.boardId);

              render(window.board);
            });
          } else {
            load(window.boardId);
          }
        });
    </script>
  </head>
  <body>
    <div class="h-100" id="board">

    </div>
  </body>
</html>
